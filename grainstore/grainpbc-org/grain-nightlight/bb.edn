{:min-bb-version "1.3.186"
 :paths ["src"]
 :deps {babashka/fs {:mvn/version "0.5.20"}
        babashka/process {:mvn/version "0.5.21"}}
 :tasks
 {:requires ([babashka.fs :as fs]
             [babashka.process :as p]
             [clojure.string :as str])
  
  nightlight:enable
  {:doc "Enable GNOME Night Light with warm temperature (usage: bb nightlight:enable [temp])"
   :task (let [temp (or (first *command-line-args*) "2000")]
           (println "🌙 Enabling GNOME Night Light")
           (println (str "   Temperature: " temp "K (warmer = lower number)"))
           (println "")
           (p/shell "gsettings" "set" "org.gnome.settings-daemon.plugins.color" "night-light-enabled" "true")
           (println "✅ Night Light enabled")
           (p/shell "gsettings" "set" "org.gnome.settings-daemon.plugins.color" "night-light-temperature" temp)
           (println (str "✅ Temperature set to " temp "K"))
           (p/shell "gsettings" "set" "org.gnome.settings-daemon.plugins.color" "night-light-schedule-automatic" "false")
           (println "✅ Schedule set to manual (always on)")
           (println "")
           (println "🌙 Warm lighting active! Your eyes will thank you."))}
  
  nightlight:status
  {:doc "Check GNOME Night Light status"
   :task (do
           (println "🌙 GNOME Night Light Status")
           (println "═══════════════════════════════════════════")
           (println "")
           (let [enabled (str/trim (:out (p/shell {:out :string} "gsettings" "get" "org.gnome.settings-daemon.plugins.color" "night-light-enabled")))
                 temp (str/trim (:out (p/shell {:out :string} "gsettings" "get" "org.gnome.settings-daemon.plugins.color" "night-light-temperature")))
                 auto (str/trim (:out (p/shell {:out :string} "gsettings" "get" "org.gnome.settings-daemon.plugins.color" "night-light-schedule-automatic")))]
             (println (str "Enabled: " (if (= enabled "true") "✅ Yes" "❌ No")))
             (println (str "Temperature: " temp "K" 
                          (cond
                            (re-find (re-pattern "1[0-9]{3}|2000") temp) " (🌙 maximum warmth)"
                            (re-find (re-pattern "2[5-9][0-9]{2}|3[0-9]{3}") temp) " (🌤️ warm)"
                            :else " (☀️ cool)")))
             (println (str "Schedule: " (if (= auto "true") "🌅 Automatic (sunset/sunrise)" "⏰ Manual (always on)")))
             (println "")))}
  
  nightlight:disable
  {:doc "Disable GNOME Night Light"
   :task (do
           (println "Disabling Night Light...")
           (p/shell "gsettings" "set" "org.gnome.settings-daemon.plugins.color" "night-light-enabled" "false")
           (println "✅ Night Light disabled"))}
  
  nightlight:diagnose
  {:doc "Run full diagnostic and restart color daemon"
   :task (shell "bb" "scripts/diagnose.bb")}
  
  nightlight:install
  {:doc "Install systemd service for auto-start on boot"
   :task (shell "bb" "scripts/install-systemd.bb")}
  
  nightlight:test
  {:doc "Test Night Light control"
   :task (do
           (println "🧪 Testing Night Light Control")
           (println "")
           (println "1. Checking gsettings availability...")
           (let [result (p/shell {:out :string :continue true} "which" "gsettings")]
             (if (= 0 (:exit result))
               (println "   ✅ gsettings found")
               (println "   ❌ gsettings not found (is GNOME installed?)")))
           (println "")
           (println "2. Checking current status...")
           (shell "bb" "nightlight:status")
           (println "")
           (println "3. Testing enable/disable cycle...")
           (println "   Saving current state...")
           (let [was-enabled (str/trim (:out (p/shell {:out :string} "gsettings" "get" "org.gnome.settings-daemon.plugins.color" "night-light-enabled")))]
             (println "   Testing disable...")
             (shell "bb" "nightlight:disable")
             (Thread/sleep 1000)
             (println "   Testing enable...")
             (shell "bb" "nightlight:enable" "2000")
             (Thread/sleep 1000)
             (println "   Restoring original state...")
             (p/shell "gsettings" "set" "org.gnome.settings-daemon.plugins.color" "night-light-enabled" was-enabled))
           (println "")
           (println "✅ Test complete!"))}}}

