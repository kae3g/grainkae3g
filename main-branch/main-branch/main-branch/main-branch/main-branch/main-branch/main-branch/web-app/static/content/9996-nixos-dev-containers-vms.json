{
  "slug" : "9996-nixos-dev-containers-vms",
  "meta" : {
    "slug" : "9996-nixos-dev-containers-vms",
    "title" : "kae3g 9996: NixOS Development Environments — VMs, Containers, and Build Management",
    "filename" : "9996-nixos-dev-containers-vms.md",
    "source-dir" : "hidden"
  },
  "html" : "<h1>kae3g 9996: NixOS Development Environments — VMs, Containers, and Build Management</h1><p><strong>Timestamp:</strong> 12025-10-05&ndash;06thhouse01984<br /> <strong>Series:</strong> Technical Writings (9999 → 0000)<br /> <strong>Category:</strong> Development Environment, Infrastructure, Build Systems, Philosophy<br /> <strong>Reading Time:</strong> 110 minutes</p><h2>The Question</h2><p><em>How do we create a reproducible, declarative NixOS development environment within VirtualBox on macOS Sequoia, with our project dependencies automatically configured and fully documented?</em></p><h2>Introduction: The Garden Within a Garden</h2><pre><code class=\"clojure\">{:the-parable\n &quot;A gardener in the mountains &#40;macOS&#41; builds a greenhouse &#40;VirtualBox&#41;\n  to grow alpine flowers &#40;NixOS&#41; that require specific soil &#40;Nix packages&#41;.\n  \n  The greenhouse is portable, the soil is reproducible,\n  the flowers bloom identically whether in spring or winter.\n  \n  This is virtualization as cultivation,\n  isolation as preservation,\n  declarative configuration as seed catalog.&quot;}\n</code></pre><p>In the Ch'an tradition, there's a concept called <em>\"garden within garden\"</em> (園中園)—creating a microcosm that reflects and perfects the macrocosm. VirtualBox on macOS with NixOS inside represents this: a controlled, reproducible environment nested within the host system.</p><h2>Why VirtualBox + NixOS on macOS?</h2><pre><code class=\"clojure\">{:the-case-for-virtualization\n {:host-preservation\n  &quot;Keep macOS clean—no system-level package pollution&quot;\n  \n  :reproducibility\n  &quot;VM configuration as code—delete, recreate identically&quot;\n  \n  :isolation\n  &quot;Development environment completely separated from host&quot;\n  \n  :portability\n  &quot;Export VM, share with team, guaranteed identical setup&quot;\n  \n  :experimentation\n  &quot;Try configurations without fear—snapshots protect you&quot;\n  \n  :linux-specificity\n  &quot;Some tools &#40;Docker, systemd&#41; work better on Linux&quot;}\n \n :the-case-for-nixos\n {:declarative-everything\n  &quot;Entire VM configuration in version control&quot;\n  \n  :reproducible-packages\n  &quot;flake.lock guarantees identical package versions&quot;\n  \n  :atomic-upgrades\n  &quot;Upgrade VM packages atomically, rollback if issues&quot;\n  \n  :minimal-footprint\n  &quot;NixOS minimal ISO starts tiny, add only what you need&quot;\n  \n  :consistency-with-project\n  &quot;Your project already uses Nix—extend to VM layer&quot;}}\n</code></pre><p><strong>From the I Ching:</strong></p><blockquote><p> Hexagram 52: Keeping Still (艮 Gèn) — The Mountain <br /> *\"Keeping his back still so that he no longer feels his body. <br /> He goes into his courtyard and does not see his people. <br /> No blame.\"* </p></blockquote><p>The VM is like the mountain—still, stable, unchanging. Inside, development flows freely, but the mountain itself remains unmoved.</p><h2>Prerequisites</h2><h3>On macOS Host</h3><pre><code class=\"bash\"># Install VirtualBox\nbrew install --cask virtualbox\n\n# Verify installation\nVBoxManage --version  # Should show: 7.0.x or higher\n\n# Optional: Install VirtualBox Extension Pack &#40;for USB, RDP&#41;\n# Download from: https://www.virtualbox.org/wiki/Downloads\n# Install via VirtualBox GUI: Preferences → Extensions\n</code></pre><pre><code class=\"clojure\">{:macos-requirements\n {:os-version &quot;macOS 12 &#40;Monterey&#41; or later&quot;\n  :recommended &quot;macOS 15 &#40;Sequoia/Tahoe&#41;&quot;\n  :disk-space &quot;At least 40 GB free&quot;\n  :ram &quot;At least 8 GB total &#40;will allocate 4 GB to VM&#41;&quot;\n  :cpu &quot;Intel or Apple Silicon with Rosetta 2&quot;\n  :note &quot;On Apple Silicon, performance will be slower &#40;x86 emulation&#41;&quot;}}\n</code></pre><h3>Project Repository</h3><p>Your Robotic Farm project should be cloned locally:</p><pre><code class=\"bash\">cd &#126;/kae3g\ngit clone https://codeberg.org/kae3g/12025-10-04.git\ncd 12025-10-04\n</code></pre><h2>Automated Setup (Recommended)</h2><p>We've created automation scripts in <code>scripts/</code> that handle the entire process:</p><pre><code class=\"bash\"># 1. Create and configure the VM\n./scripts/setup-virtualbox-vm.sh\n\n# 2. Start the VM\nVBoxManage startvm robotic-farm-nixos --type gui\n\n# 3. Inside the VM &#40;after it boots&#41;, install NixOS\n# &#40;Follow on-screen instructions or use the install script&#41;\n</code></pre><h3>What the Automation Does</h3><pre><code class=\"clojure\">{:automated-steps\n &#91;&quot;1. Check VirtualBox installation&quot;\n  &quot;2. Download NixOS minimal ISO &#40;if not cached&#41;&quot;\n  &quot;3. Create VM with optimal settings:\n      - 4 GB RAM &#40;configurable&#41;\n      - 2 CPUs &#40;configurable&#41;\n      - 30 GB disk &#40;configurable&#41;\n      - NAT networking with port forwarding&quot;\n  &quot;4. Attach NixOS ISO to VM&quot;\n  &quot;5. Configure shared folder &#40;host project → VM&#41;&quot;\n  &quot;6. Set up port forwarding:\n      - SSH: localhost:2222 → VM:22\n      - HTTP: localhost:8080 → VM:8080\n      - HTTPS: localhost:8443 → VM:443&quot;\n  &quot;7. Print next steps and connection info&quot;&#93;}\n</code></pre><h2>Manual Setup (Deep Understanding)</h2><p>If you prefer to understand every step:</p><h3>Step 1: Download NixOS Minimal ISO</h3><pre><code class=\"bash\"># Create ISOs directory\nmkdir -p &#126;/VirtualBox/ISOs\ncd &#126;/VirtualBox/ISOs\n\n# Download NixOS 24.05 minimal ISO\ncurl -L -o nixos-minimal-24.05-x86&#95;64-linux.iso \\\n  https://channels.nixos.org/nixos-24.05/latest-nixos-minimal-x86&#95;64-linux.iso\n\n# Verify download &#40;optional&#41;\nshasum -a 256 nixos-minimal-24.05-x86&#95;64-linux.iso\n</code></pre><pre><code class=\"clojure\">{:iso-choice\n {:minimal &quot;&#126;900 MB, console-only, perfect for development&quot;\n  :graphical &quot;&#126;3 GB, includes desktop environment, unnecessary for our use&quot;\n  :recommendation &quot;Use minimal—we'll SSH in from macOS&quot;}}\n</code></pre><h3>Step 2: Create the Virtual Machine</h3><pre><code class=\"bash\"># Set variables\nVM&#95;NAME=&quot;robotic-farm-nixos&quot;\nVM&#95;DIR=&quot;$HOME/VirtualBox/VMs&quot;\nISO&#95;PATH=&quot;$HOME/VirtualBox/ISOs/nixos-minimal-24.05-x86&#95;64-linux.iso&quot;\n\n# Create VM\nVBoxManage createvm \\\n  --name &quot;${VM&#95;NAME}&quot; \\\n  --ostype &quot;Linux&#95;64&quot; \\\n  --register \\\n  --basefolder &quot;${VM&#95;DIR}&quot;\n\n# Configure resources\nVBoxManage modifyvm &quot;${VM&#95;NAME}&quot; \\\n  --memory 4096 \\\n  --cpus 2 \\\n  --vram 16 \\\n  --boot1 dvd \\\n  --boot2 disk \\\n  --boot3 none \\\n  --boot4 none \\\n  --firmware bios \\\n  --chipset piix3 \\\n  --pae on \\\n  --longmode on \\\n  --hpet on \\\n  --hwvirtex on \\\n  --nestedpaging on \\\n  --largepages on \\\n  --vtxvpid on\n\n# Create disk &#40;30 GB&#41;\nVBoxManage createhd \\\n  --filename &quot;${VM&#95;DIR}/${VM&#95;NAME}/${VM&#95;NAME}.vdi&quot; \\\n  --size 30720 \\\n  --format VDI\n\n# Add SATA controller and attach disk\nVBoxManage storagectl &quot;${VM&#95;NAME}&quot; \\\n  --name &quot;SATA Controller&quot; \\\n  --add sata \\\n  --controller IntelAhci \\\n  --portcount 2 \\\n  --hostiocache off \\\n  --bootable on\n\nVBoxManage storageattach &quot;${VM&#95;NAME}&quot; \\\n  --storagectl &quot;SATA Controller&quot; \\\n  --port 0 \\\n  --device 0 \\\n  --type hdd \\\n  --medium &quot;${VM&#95;DIR}/${VM&#95;NAME}/${VM&#95;NAME}.vdi&quot;\n\n# Add IDE controller and attach ISO\nVBoxManage storagectl &quot;${VM&#95;NAME}&quot; \\\n  --name &quot;IDE Controller&quot; \\\n  --add ide\n\nVBoxManage storageattach &quot;${VM&#95;NAME}&quot; \\\n  --storagectl &quot;IDE Controller&quot; \\\n  --port 0 \\\n  --device 0 \\\n  --type dvddrive \\\n  --medium &quot;${ISO&#95;PATH}&quot;\n\n# Configure networking &#40;NAT with port forwarding&#41;\nVBoxManage modifyvm &quot;${VM&#95;NAME}&quot; \\\n  --nic1 nat \\\n  --natpf1 &quot;ssh,tcp,,2222,,22&quot; \\\n  --natpf1 &quot;http,tcp,,8080,,8080&quot; \\\n  --natpf1 &quot;https,tcp,,8443,,443&quot;\n\n# Enable bidirectional clipboard and drag-and-drop\nVBoxManage modifyvm &quot;${VM&#95;NAME}&quot; \\\n  --clipboard-mode bidirectional \\\n  --draganddrop bidirectional\n</code></pre><pre><code class=\"clojure\">{:vm-configuration-explained\n {:memory-4096\n  &quot;4 GB RAM—enough for NixOS + Docker + Babashka builds&quot;\n  \n  :cpus-2\n  &quot;2 CPUs—parallel builds will be faster&quot;\n  \n  :disk-30720\n  &quot;30 GB disk—Nix store can grow large with many derivations&quot;\n  \n  :nat-networking\n  &quot;NAT = VM can access internet, host accesses VM via port forwarding\n   \n   Why not bridged?\n   - Bridged exposes VM to network &#40;less secure&#41;\n   - NAT is simpler, works on any network &#40;WiFi, Ethernet, VPN&#41;&quot;\n  \n  :port-forwarding\n  {:ssh &quot;Host port 2222 → VM port 22 &#40;standard SSH&#41;&quot;\n   :http &quot;Host port 8080 → VM port 8080 &#40;for web services&#41;&quot;\n   :https &quot;Host port 8443 → VM port 443 &#40;for HTTPS services&#41;&quot;}}}\n</code></pre><p><strong>Aristotelian Virtues in Configuration:</strong></p><ul><li><strong>Prudence (φρόνησις)</strong>: 4 GB RAM is the mean between stinginess (2 GB, too slow) and excess (8 GB, wasteful on laptop)</li><li><strong>Temperance (σωφροσύνη)</strong>: 30 GB disk balances space needs with host constraints</li><li><strong>Justice (δικαιοσύνη)</strong>: 2 CPUs shares host resources fairly with macOS</li></ul><h3>Step 3: Start the VM and Boot from ISO</h3><pre><code class=\"bash\"># Start VM in GUI mode\nVBoxManage startvm robotic-farm-nixos --type gui\n\n# Alternative: Start headless &#40;no window, access via SSH later&#41;\n# VBoxManage startvm robotic-farm-nixos --type headless\n</code></pre><p>The VM will boot into the NixOS installer (live environment).</p><h3>Step 4: Install NixOS (Inside the VM)</h3><p>Once the VM boots, you'll see a login prompt. Log in as <code>nixos</code> (no password needed).</p><h4>Partition the Disk</h4><pre><code class=\"bash\"># Inside the VM\nsudo -i  # Become root\n\n# List disks\nlsblk\n# Should show: sda &#40;30G disk&#41;\n\n# Partition with fdisk or use quick script:\nparted /dev/sda -- mklabel gpt\nparted /dev/sda -- mkpart primary 512MB 100%\nparted /dev/sda -- mkpart ESP fat32 1MB 512MB\nparted /dev/sda -- set 2 esp on\n\n# Format partitions\nmkfs.ext4 -L nixos /dev/sda1\nmkfs.fat -F 32 -n boot /dev/sda2\n\n# Mount\nmount /dev/disk/by-label/nixos /mnt\nmkdir -p /mnt/boot\nmount /dev/disk/by-label/boot /mnt/boot\n</code></pre><h4>Generate NixOS Configuration</h4><pre><code class=\"bash\"># Generate base configuration\nnixos-generate-config --root /mnt\n\n# Edit configuration\nnano /mnt/etc/nixos/configuration.nix\n</code></pre><p>Replace the generated configuration with:</p><pre><code class=\"nix\"># /mnt/etc/nixos/configuration.nix\n{ config, pkgs, ... }:\n\n{\n  imports = &#91; ./hardware-configuration.nix &#93;;\n\n  # Bootloader\n  boot.loader.grub.enable = true;\n  boot.loader.grub.device = &quot;/dev/sda&quot;;\n\n  # Networking\n  networking.hostName = &quot;robotic-farm-nixos&quot;;\n  networking.networkmanager.enable = true;\n\n  # Enable Flakes and nix-command\n  nix.settings.experimental-features = &#91; &quot;nix-command&quot; &quot;flakes&quot; &#93;;\n\n  # Time zone\n  time.timeZone = &quot;America/Los&#95;Angeles&quot;;  # Adjust to your timezone\n\n  # Packages\n  environment.systemPackages = with pkgs; &#91;\n    vim\n    git\n    curl\n    wget\n    htop\n  &#93;;\n\n  # Enable SSH\n  services.openssh = {\n    enable = true;\n    settings = {\n      PermitRootLogin = &quot;no&quot;;\n      PasswordAuthentication = true;  # Will disable after SSH key setup\n    };\n  };\n\n  # Enable Docker\n  virtualisation.docker.enable = true;\n\n  # Enable VirtualBox Guest Additions\n  virtualisation.virtualbox.guest.enable = true;\n  virtualisation.virtualbox.guest.x11 = false;  # No GUI needed\n\n  # User account\n  users.users.nixos = {\n    isNormalUser = true;\n    extraGroups = &#91; &quot;wheel&quot; &quot;docker&quot; &quot;vboxsf&quot; &#93;;  # vboxsf for shared folders\n    initialPassword = &quot;nixos&quot;;  # Change this after first login!\n  };\n\n  # Enable sudo without password for wheel group &#40;convenience&#41;\n  security.sudo.wheelNeedsPassword = false;\n\n  # System version\n  system.stateVersion = &quot;24.05&quot;;\n}\n</code></pre><pre><code class=\"clojure\">{:configuration-explained\n {:experimental-features\n  &quot;Enables flakes and new nix CLI—required for our project&quot;\n  \n  :openssh\n  &quot;SSH server—allows connection from macOS host&quot;\n  \n  :docker\n  &quot;Docker daemon for container work&quot;\n  \n  :virtualbox-guest\n  &quot;Guest Additions—enables shared folders, clipboard, time sync&quot;\n  \n  :user-groups\n  {:wheel &quot;Sudo access&quot;\n   :docker &quot;Run Docker without sudo&quot;\n   :vboxsf &quot;Access VirtualBox shared folders&quot;}}}\n</code></pre><h4>Install and Reboot</h4><pre><code class=\"bash\"># Inside the VM, still as root\nnixos-install\n\n# Set root password when prompted &#40;or skip and rely on nixos user&#41;\n\n# Reboot\nreboot\n</code></pre><p>The VM will reboot. <strong>Remove the ISO</strong> from the VM's optical drive so it boots from disk:</p><pre><code class=\"bash\"># On macOS host, while VM is shutting down:\nVBoxManage storageattach robotic-farm-nixos \\\n  --storagectl &quot;IDE Controller&quot; \\\n  --port 0 \\\n  --device 0 \\\n  --type dvddrive \\\n  --medium none\n</code></pre><h3>Step 5: SSH Setup (from macOS to VM)</h3><p>Once the VM has rebooted and you see the login prompt:</p><h4>Inside the VM</h4><pre><code class=\"bash\"># Log in as nixos user\n# Password: nixos &#40;or whatever you set&#41;\n\n# Get IP address &#40;should be 10.0.2.15 with NAT&#41;\nip addr show\n\n# Start SSH service &#40;should already be running&#41;\nsudo systemctl status sshd\n</code></pre><h4>On macOS Host</h4><pre><code class=\"bash\"># Test SSH connection\nssh -p 2222 nixos@localhost\n# Password: nixos\n\n# Generate SSH key pair &#40;if you don't have one&#41;\nssh-keygen -t ed25519 -f &#126;/.ssh/id&#95;ed25519&#95;nixos&#95;vm -C &quot;nixos-vm&quot;\n\n# Copy public key to VM\nssh-copy-id -p 2222 -i &#126;/.ssh/id&#95;ed25519&#95;nixos&#95;vm nixos@localhost\n\n# Add to &#126;/.ssh/config for convenience\ncat &gt;&gt; &#126;/.ssh/config &lt;&lt; 'EOF'\n\nHost robotic-farm-vm\n  HostName localhost\n  Port 2222\n  User nixos\n  IdentityFile &#126;/.ssh/id&#95;ed25519&#95;nixos&#95;vm\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null\n\nEOF\n\n# Now connect easily:\nssh robotic-farm-vm\n</code></pre><h4>Disable Password Authentication (Security)</h4><p>Once SSH key works, disable password auth:</p><pre><code class=\"bash\"># On VM\nsudo nano /etc/nixos/configuration.nix\n\n# Change:\n# PasswordAuthentication = true;\n# To:\n# PasswordAuthentication = false;\n\n# Rebuild\nsudo nixos-rebuild switch\n\n# Test &#40;from macOS&#41;:\nssh robotic-farm-vm  # Should work with key\n</code></pre><h3>Step 6: Configure Shared Folder</h3><h4>On macOS Host</h4><pre><code class=\"bash\"># Add shared folder\nVBoxManage sharedfolder add robotic-farm-nixos \\\n  --name &quot;robotic-farm&quot; \\\n  --hostpath &quot;/Users/YOUR&#95;USERNAME/kae3g/12025-10-04&quot; \\\n  --automount \\\n  --auto-mount-point &quot;/home/nixos/robotic-farm&quot;\n\n# Restart VM to apply\nVBoxManage controlvm robotic-farm-nixos acpipowerbutton\n# Wait for graceful shutdown, then:\nVBoxManage startvm robotic-farm-nixos --type headless\n</code></pre><h4>On VM</h4><pre><code class=\"bash\">ssh robotic-farm-vm\n\n# Verify shared folder is mounted\nls -la &#126;/robotic-farm\n# Should see your project files!\n\n# If not mounted, mount manually:\nsudo mount -t vboxsf -o uid=1000,gid=100 robotic-farm &#126;/robotic-farm\n</code></pre><pre><code class=\"clojure\">{:shared-folder-benefits\n &#91;&quot;Edit files on macOS with your preferred editor&quot;\n  &quot;Changes immediately visible in VM&quot;\n  &quot;No git push/pull needed for local dev&quot;\n  &quot;Build artifacts from VM available on macOS&quot;&#93;\n \n :shared-folder-caveats\n &#91;&quot;Performance slower than native filesystem&quot;\n  &quot;Some file watchers might not work &#40;webpack, etc.&#41;&quot;\n  &quot;Symlinks can be problematic&quot;\n  &quot;For intensive I/O, copy to VM's local disk&quot;&#93;}\n</code></pre><h3>Step 7: Project Setup in VM</h3><pre><code class=\"bash\"># SSH into VM\nssh robotic-farm-vm\n\n# Navigate to project\ncd &#126;/robotic-farm\n\n# Enter development shell\nnix develop\n\n# Verify everything works\nbb --version\nclj --version\nnode --version\n\n# Run build pipeline\nbb build:pipeline\n\n# Success! 🎉\n</code></pre><pre><code class=\"clojure\">{:the-moment-of-truth\n &quot;All your project dependencies—babashka, clojure, node—\n  are now available in the VM, declaratively configured,\n  reproducibly installed.\n  \n  The garden within the garden is complete.\n  Alpine flowers bloom in the greenhouse.\n  The microcosm reflects the macrocosm.&quot;}\n</code></pre><h2>Advanced Configuration</h2><h3>Optimized NixOS Configuration for Development</h3><p>Create a custom configuration that integrates with your project:</p><pre><code class=\"bash\"># On VM\nsudo nano /etc/nixos/configuration.nix\n</code></pre><pre><code class=\"nix\"># Enhanced configuration for Robotic Farm development\n{ config, pkgs, ... }:\n\n{\n  imports = &#91; ./hardware-configuration.nix &#93;;\n\n  # Bootloader\n  boot.loader.grub.enable = true;\n  boot.loader.grub.device = &quot;/dev/sda&quot;;\n\n  # Networking\n  networking.hostName = &quot;robotic-farm-nixos&quot;;\n  networking.networkmanager.enable = true;\n  networking.firewall.allowedTCPPorts = &#91; 22 8080 443 3000 &#93;;\n\n  # Nix configuration\n  nix = {\n    settings = {\n      experimental-features = &#91; &quot;nix-command&quot; &quot;flakes&quot; &#93;;\n      auto-optimise-store = true;\n      max-jobs = 2;\n    };\n    gc = {\n      automatic = true;\n      dates = &quot;weekly&quot;;\n      options = &quot;--delete-older-than 30d&quot;;\n    };\n  };\n\n  # Time zone\n  time.timeZone = &quot;America/Los&#95;Angeles&quot;;\n\n  # Locale\n  i18n.defaultLocale = &quot;en&#95;US.UTF-8&quot;;\n\n  # System packages\n  environment.systemPackages = with pkgs; &#91;\n    # Editors\n    vim\n    neovim\n    \n    # Version control\n    git\n    git-lfs\n    \n    # Shell utilities\n    curl\n    wget\n    htop\n    btop\n    tmux\n    screen\n    ripgrep\n    fd\n    jq\n    yq\n    \n    # Development tools\n    gnumake\n    gcc\n    \n    # Clojure ecosystem &#40;from nixpkgs&#41;\n    babashka\n    clojure\n    clj-kondo\n    clojure-lsp\n    \n    # Node.js\n    nodejs&#95;22\n    \n    # Container tools\n    docker-compose\n    \n    # Utilities\n    unzip\n    zip\n    tree\n    ncdu\n  &#93;;\n\n  # Shell configuration\n  programs.bash.enableCompletion = true;\n  programs.bash.shellAliases = {\n    ll = &quot;ls -alF&quot;;\n    la = &quot;ls -A&quot;;\n    l = &quot;ls -CF&quot;;\n    ..= &quot;cd ..&quot;;\n    ...= &quot;cd ../..&quot;;\n    rf = &quot;cd &#126;/robotic-farm&quot;;\n  };\n\n  # SSH\n  services.openssh = {\n    enable = true;\n    settings = {\n      PermitRootLogin = &quot;no&quot;;\n      PasswordAuthentication = false;\n      X11Forwarding = false;\n    };\n  };\n\n  # Docker\n  virtualisation.docker = {\n    enable = true;\n    autoPrune = {\n      enable = true;\n      dates = &quot;weekly&quot;;\n    };\n  };\n\n  # VirtualBox Guest\n  virtualisation.virtualbox.guest = {\n    enable = true;\n    x11 = false;\n  };\n\n  # User\n  users.users.nixos = {\n    isNormalUser = true;\n    description = &quot;Robotic Farm Developer&quot;;\n    extraGroups = &#91; &quot;wheel&quot; &quot;docker&quot; &quot;vboxsf&quot; &#93;;\n    shell = pkgs.bash;\n    openssh.authorizedKeys.keys = &#91;\n      # Add your SSH public key here\n      # &quot;ssh-ed25519 AAAA... you@macbook&quot;\n    &#93;;\n  };\n\n  # Sudo without password\n  security.sudo.wheelNeedsPassword = false;\n\n  # Automatic upgrades &#40;optional&#41;\n  system.autoUpgrade = {\n    enable = false;  # Set to true if desired\n    allowReboot = false;\n    channel = &quot;https://nixos.org/channels/nixos-24.05&quot;;\n  };\n\n  system.stateVersion = &quot;24.05&quot;;\n}\n</code></pre><p>Apply the configuration:</p><pre><code class=\"bash\">sudo nixos-rebuild switch\n</code></pre><h3>Snapshot Strategy</h3><pre><code class=\"bash\"># On macOS host\n\n# Create snapshot before major changes\nVBoxManage snapshot robotic-farm-nixos take &quot;pre-upgrade-$&#40;date +%Y%m%d&#41;&quot; \\\n  --description &quot;Before NixOS upgrade&quot;\n\n# List snapshots\nVBoxManage snapshot robotic-farm-nixos list\n\n# Restore snapshot if something breaks\nVBoxManage snapshot robotic-farm-nixos restore &quot;pre-upgrade-20251006&quot;\n\n# Delete old snapshots\nVBoxManage snapshot robotic-farm-nixos delete &quot;old-snapshot-name&quot;\n</code></pre><pre><code class=\"clojure\">{:snapshot-philosophy\n &quot;Like Git for your entire VM state.\n  \n  Create snapshots before:\n  - Major NixOS upgrades\n  - Experimental configurations\n  - Dependency updates\n  - System reconfigurations\n  \n  Snapshots enable fearless experimentation.\n  This is the Sabbath principle applied to VMs:\n  Return to a known good state, begin anew.&quot;}\n</code></pre><h3>Performance Tuning</h3><pre><code class=\"bash\"># On macOS host\n\n# Increase video memory &#40;if experiencing display issues&#41;\nVBoxManage modifyvm robotic-farm-nixos --vram 128\n\n# Enable PAE/NX &#40;if not already enabled&#41;\nVBoxManage modifyvm robotic-farm-nixos --pae on\n\n# Adjust I/O APIC &#40;can improve performance on multi-core&#41;\nVBoxManage modifyvm robotic-farm-nixos --ioapic on\n\n# Enable nested paging &#40;if supported by your CPU&#41;\nVBoxManage modifyvm robotic-farm-nixos --nestedpaging on\n\n# Adjust paravirtualization interface\nVBoxManage modifyvm robotic-farm-nixos --paravirtprovider kvm  # or default\n</code></pre><pre><code class=\"clojure\">{:performance-expectations\n {:native-speed 100\n  :virtualbox-intel 70-80\n  :virtualbox-apple-silicon 30-50}\n \n :note\n &quot;VirtualBox on Apple Silicon uses x86 emulation via Rosetta 2.\n  Performance will be noticeably slower.\n  \n  For Apple Silicon, consider:\n  - UTM &#40;supports ARM64 natively&#41;\n  - Docker Desktop for Mac &#40;uses hypervisor.framework&#41;\n  - But lose some VirtualBox convenience features&quot;}\n</code></pre><h2>Automated Scripts for the Repository</h2><p>Let's create three scripts to include in your project:</p><h3>Script 1: setup-virtualbox-vm.sh</h3><p>(Already created above—will go in <code>scripts/</code> directory)</p><h3>Script 2: install-nixos-in-vm.sh</h3><pre><code class=\"bash\">#!/usr/bin/env bash\n# install-nixos-in-vm.sh\n# Run this INSIDE the VM after it boots from ISO\n# Automates NixOS installation\n\nset -euo pipefail\n\n# Configuration\nDISK=&quot;/dev/sda&quot;\nTIMEZONE=&quot;America/Los&#95;Angeles&quot;\nHOSTNAME=&quot;robotic-farm-nixos&quot;\n\necho &quot;⚠️  WARNING: This will ERASE ${DISK}!&quot;\nread -p &quot;Continue? &#40;yes/no&#41;: &quot; confirm\nif &#91;&#91; &quot;$confirm&quot; != &quot;yes&quot; &#93;&#93;; then\n    echo &quot;Aborted.&quot;\n    exit 1\nfi\n\necho &quot;🔧 Partitioning ${DISK}...&quot;\nparted ${DISK} -- mklabel gpt\nparted ${DISK} -- mkpart primary 512MB 100%\nparted ${DISK} -- mkpart ESP fat32 1MB 512MB\nparted ${DISK} -- set 2 esp on\n\necho &quot;📁 Formatting partitions...&quot;\nmkfs.ext4 -L nixos ${DISK}1\nmkfs.fat -F 32 -n boot ${DISK}2\n\necho &quot;🔗 Mounting filesystems...&quot;\nmount /dev/disk/by-label/nixos /mnt\nmkdir -p /mnt/boot\nmount /dev/disk/by-label/boot /mnt/boot\n\necho &quot;📝 Generating configuration...&quot;\nnixos-generate-config --root /mnt\n\n# Inject our custom configuration\ncat &gt; /mnt/etc/nixos/configuration.nix &lt;&lt; 'NIXCONF'\n{ config, pkgs, ... }:\n\n{\n  imports = &#91; ./hardware-configuration.nix &#93;;\n  \n  boot.loader.grub.enable = true;\n  boot.loader.grub.device = &quot;/dev/sda&quot;;\n  \n  networking.hostName = &quot;robotic-farm-nixos&quot;;\n  networking.networkmanager.enable = true;\n  \n  nix.settings.experimental-features = &#91; &quot;nix-command&quot; &quot;flakes&quot; &#93;;\n  nix.settings.auto-optimise-store = true;\n  \n  time.timeZone = &quot;America/Los&#95;Angeles&quot;;\n  \n  environment.systemPackages = with pkgs; &#91;\n    vim git curl wget htop tmux\n  &#93;;\n  \n  services.openssh = {\n    enable = true;\n    settings = {\n      PermitRootLogin = &quot;no&quot;;\n      PasswordAuthentication = true;\n    };\n  };\n  \n  virtualisation.docker.enable = true;\n  virtualisation.virtualbox.guest.enable = true;\n  virtualisation.virtualbox.guest.x11 = false;\n  \n  users.users.nixos = {\n    isNormalUser = true;\n    extraGroups = &#91; &quot;wheel&quot; &quot;docker&quot; &quot;vboxsf&quot; &#93;;\n    initialPassword = &quot;nixos&quot;;\n  };\n  \n  security.sudo.wheelNeedsPassword = false;\n  \n  system.stateVersion = &quot;24.05&quot;;\n}\nNIXCONF\n\necho &quot;🚀 Installing NixOS...&quot;\nnixos-install --no-root-password\n\necho &quot;✅ Installation complete!&quot;\necho &quot;&quot;\necho &quot;Next steps:&quot;\necho &quot;1. Type 'reboot'&quot;\necho &quot;2. Remove ISO from VM optical drive&quot;\necho &quot;3. Boot into installed system&quot;\necho &quot;4. Log in as: nixos / nixos&quot;\necho &quot;5. Change password: passwd&quot;\n</code></pre><h3>Script 3: connect-to-vm.sh</h3><pre><code class=\"bash\">#!/usr/bin/env bash\n# connect-to-vm.sh\n# Convenient wrapper for SSH into the VM\n\nVM&#95;NAME=&quot;robotic-farm-nixos&quot;\nSSH&#95;PORT=&quot;2222&quot;\nSSH&#95;USER=&quot;nixos&quot;\n\n# Check if VM is running\nif ! VBoxManage list runningvms | grep -q &quot;${VM&#95;NAME}&quot;; then\n    echo &quot;❌ VM '${VM&#95;NAME}' is not running&quot;\n    echo &quot;&quot;\n    echo &quot;Start it with:&quot;\n    echo &quot;  VBoxManage startvm ${VM&#95;NAME} --type headless&quot;\n    exit 1\nfi\n\n# Connect\necho &quot;🔗 Connecting to ${VM&#95;NAME}...&quot;\nssh -p ${SSH&#95;PORT} ${SSH&#95;USER}@localhost\n</code></pre><h2>Integration with Project Flake</h2><p>Update your project's <code>flake.nix</code> to document VM setup:</p><pre><code class=\"nix\"># Add to your existing flake.nix\n{\n  description = &quot;Robotic Farm with VirtualBox VM support&quot;;\n\n  inputs = {\n    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;\n  };\n\n  outputs = { self, nixpkgs }: {\n    # Existing outputs...\n    \n    # NixOS configuration for VirtualBox VM\n    nixosConfigurations.robotic-farm-vm = nixpkgs.lib.nixosSystem {\n      system = &quot;x86&#95;64-linux&quot;;\n      modules = &#91;\n        # Can reference a separate vm-configuration.nix file\n        ./nixos/vm-configuration.nix\n      &#93;;\n    };\n    \n    # Development shell &#40;existing&#41;\n    devShells.x86&#95;64-linux.default = # ...\n    \n    # VM-specific dev shell &#40;optional&#41;\n    devShells.x86&#95;64-linux.vm = \n      let pkgs = nixpkgs.legacyPackages.x86&#95;64-linux;\n      in pkgs.mkShell {\n        buildInputs = with pkgs; &#91;\n          # VM management tools\n          virtualbox\n          \n          # Your regular dev tools\n          babashka\n          clojure\n          nodejs&#95;22\n        &#93;;\n        \n        shellHook = ''\n          echo &quot;Robotic Farm VM Development Shell&quot;\n          echo &quot;==================================&quot;\n          echo &quot;&quot;\n          echo &quot;VM Commands:&quot;\n          echo &quot;  ./scripts/setup-virtualbox-vm.sh  - Create VM&quot;\n          echo &quot;  ./scripts/connect-to-vm.sh        - SSH into VM&quot;\n          echo &quot;&quot;\n        '';\n      };\n  };\n}\n</code></pre><h2>Troubleshooting</h2><pre><code class=\"clojure\">{:common-issues\n {:vm-wont-start\n  {:symptoms &quot;Black screen, boot loop, or immediate crash&quot;\n   :solutions\n   &#91;&quot;Check VirtualBox logs: &#126;/VirtualBox/VMs/robotic-farm-nixos/Logs/&quot;\n    &quot;Verify virtualization enabled in BIOS &#40;Intel VT-x / AMD-V&#41;&quot;\n    &quot;On macOS: System Preferences → Security → Allow VirtualBox kernel extension&quot;\n    &quot;Try: VBoxManage modifyvm robotic-farm-nixos --firmware efi&quot;&#93;}\n  \n  :ssh-connection-refused\n  {:symptoms &quot;Connection refused on port 2222&quot;\n   :solutions\n   &#91;&quot;Check VM is running: VBoxManage list runningvms&quot;\n    &quot;Inside VM: sudo systemctl status sshd&quot;\n    &quot;Check port forwarding: VBoxManage showvminfo robotic-farm-nixos | grep ssh&quot;\n    &quot;Verify firewall: sudo nixos-rebuild switch&quot;&#93;}\n  \n  :shared-folder-not-working\n  {:symptoms &quot;&#126;/robotic-farm directory empty or doesn't exist&quot;\n   :solutions\n   &#91;&quot;Check Guest Additions: lsmod | grep vboxsf&quot;\n    &quot;Verify mount: mount | grep vboxsf&quot;\n    &quot;Manual mount: sudo mount -t vboxsf -o uid=1000,gid=100 robotic-farm &#126;/robotic-farm&quot;\n    &quot;Add to /etc/fstab for automatic mounting&quot;&#93;}\n  \n  :slow-performance\n  {:symptoms &quot;Builds taking forever, system laggy&quot;\n   :solutions\n   &#91;&quot;Allocate more RAM: VBoxManage modifyvm robotic-farm-nixos --memory 6144&quot;\n    &quot;More CPUs: VBoxManage modifyvm robotic-farm-nixos --cpus 4&quot;\n    &quot;Enable nested paging: VBoxManage modifyvm robotic-farm-nixos --nestedpaging on&quot;\n    &quot;On Apple Silicon: Consider UTM or Docker Desktop instead&quot;&#93;}\n  \n  :nix-build-fails\n  {:symptoms &quot;nix build or nix develop fails with obscure errors&quot;\n   :solutions\n   &#91;&quot;Update flake.lock: nix flake update&quot;\n    &quot;Clear Nix cache: nix-collect-garbage -d&quot;\n    &quot;Check disk space: df -h&quot;\n    &quot;Verify internet connection: curl -I https://cache.nixos.org&quot;&#93;}\n  \n  :guest-additions-missing\n  {:symptoms &quot;Shared folders, clipboard don't work&quot;\n   :solutions\n   &#91;&quot;In /etc/nixos/configuration.nix, ensure: virtualisation.virtualbox.guest.enable = true&quot;\n    &quot;Rebuild: sudo nixos-rebuild switch&quot;\n    &quot;Reboot VM&quot;\n    &quot;Check: lsmod | grep vbox&quot;&#93;}}}\n</code></pre><h2>Documentation Structure in Repository</h2><p>Create these files:</p><pre><code>12025-10-04/\n├── scripts/\n│   ├── setup-virtualbox-vm.sh         # Automates VM creation\n│   ├── install-nixos-in-vm.sh         # Run inside VM to install NixOS\n│   └── connect-to-vm.sh               # Convenient SSH wrapper\n├── nixos/\n│   ├── vm-configuration.nix           # Declarative VM config\n│   └── README.md                      # NixOS-specific docs\n├── docs/\n│   └── VIRTUALBOX-SETUP.md            # User-facing setup guide\n└── writings/\n    └── 9996-nixos-dev-containers-vms.md # This deep dive\n</code></pre><h2>The Five Virtues of This Setup</h2><pre><code class=\"clojure\">{:confucian-five-virtues\n {:仁-ren-benevolence\n  &quot;The setup is kind to beginners—automated scripts,\n   clear documentation, multiple entry points.&quot;\n  \n  :義-yi-righteousness\n  &quot;The configuration is declarative and version-controlled,\n   making it morally correct &#40;reproducible, auditable&#41;.&quot;\n  \n  :禮-li-propriety\n  &quot;The structure follows conventions—Nix flakes, NixOS modules,\n   standard paths &#40;/etc/nixos/configuration.nix&#41;.&quot;\n  \n  :智-zhi-wisdom\n  &quot;The design balances flexibility and constraint—\n   opinionated defaults, but easily customizable.&quot;\n  \n  :信-xin-trustworthiness\n  &quot;The documentation is honest about tradeoffs—\n   performance on Apple Silicon, shared folder caveats.&quot;}}\n</code></pre><h2>Comparison with Alternatives</h2><pre><code class=\"clojure\">{:alternatives\n {:docker-desktop-for-mac\n  {:pros &#91;&quot;Faster than VirtualBox&quot;\n          &quot;Native hypervisor &#40;not emulation&#41;&quot;\n          &quot;Integrated with macOS&quot;&#93;\n   :cons &#91;&quot;Black box—less control&quot;\n          &quot;macOS only&quot;\n          &quot;Not NixOS &#40;loses declarative host config&#41;&quot;&#93;\n   :use-when &quot;Just need Docker, don't care about full NixOS&quot;}\n  \n  :utm-on-apple-silicon\n  {:pros &#91;&quot;Native ARM64 support &#40;fast on M1/M2/M3&#41;&quot;\n          &quot;Can run ARM NixOS images&quot;\n          &quot;Better performance than VirtualBox&quot;&#93;\n   :cons &#91;&quot;Less mature than VirtualBox&quot;\n          &quot;Fewer features &#40;snapshots, export/import&#41;&quot;\n          &quot;ARM64 vs x86&#95;64 might cause compatibility issues&quot;&#93;\n   :use-when &quot;On Apple Silicon and need performance&quot;}\n  \n  :multipass\n  {:pros &#91;&quot;Canonical's official Ubuntu VM tool&quot;\n          &quot;Very lightweight&quot;\n          &quot;Fast instance creation&quot;&#93;\n   :cons &#91;&quot;Ubuntu-focused &#40;not NixOS&#41;&quot;\n          &quot;Less control than VirtualBox&quot;\n          &quot;Not declarative&quot;&#93;\n   :use-when &quot;Need quick Ubuntu instances, not Nix&quot;}\n  \n  :vagrant\n  {:pros &#91;&quot;Infrastructure as code&quot;\n          &quot;Large community&quot;\n          &quot;Cross-platform &#40;VirtualBox, VMware, Hyper-V&#41;&quot;&#93;\n   :cons &#91;&quot;Extra layer of abstraction&quot;\n          &quot;Ruby dependency&quot;\n          &quot;Nix flakes make Vagrant less necessary&quot;&#93;\n   :use-when &quot;Team is already using Vagrant&quot;}\n  \n  :nixos-on-bare-metal\n  {:pros &#91;&quot;Maximum performance&quot;\n          &quot;Full control&quot;\n          &quot;No virtualization overhead&quot;&#93;\n   :cons &#91;&quot;Requires dedicated machine or dual-boot&quot;\n          &quot;Less flexible &#40;can't snapshot easily&#41;&quot;\n          &quot;Riskier &#40;could break bootloader&#41;&quot;&#93;\n   :use-when &quot;Fully committed to NixOS as daily driver&quot;}}}\n</code></pre><p><strong>Recommendation for Robotic Farm:</strong></p><pre><code class=\"clojure\">{:our-choice :virtualbox-nixos\n :reasoning\n &#91;&quot;We already use Nix &#40;flake.nix&#41;—extend to VM layer&quot;\n  &quot;VirtualBox is mature, well-documented, cross-platform&quot;\n  &quot;Snapshots enable fearless experimentation&quot;\n  &quot;Shared folders make development smooth&quot;\n  &quot;Declarative VM config fits project philosophy&quot;\n  &quot;Can export VM and share with team&quot;\n  &quot;Works on both Intel and Apple Silicon Macs &#40;albeit slower on ARM&#41;&quot;&#93;\n \n :trade-offs-accepted\n &#91;&quot;Performance penalty &#40;acceptable for development&#41;&quot;\n  &quot;Slower on Apple Silicon &#40;but still usable&#41;&quot;\n  &quot;Shared folder I/O not as fast as native &#40;minor issue&#41;&quot;&#93;\n \n :future-evolution\n &quot;If team grows, consider:\n  - NixOS cloud instances &#40;AWS, GCP, Digital Ocean&#41;\n  - NixOS bare metal for CI/CD\n  - But keep VirtualBox for local development&quot;\n}\n</code></pre><h2>The Way of the Garden</h2><pre><code class=\"clojure\">{:from-ch-an\n &quot;\\&quot;The garden is not separate from the mind.\n   The mind is not separate from the garden.\n   When you tend the garden, you tend the mind.\\&quot;\n   \n   Our VM is a garden:\n   - Carefully planned &#40;configuration.nix&#41;\n   - Regularly tended &#40;nixos-rebuild switch&#41;\n   - Protected from wilderness &#40;snapshots&#41;\n   - Yielding fruits &#40;reproducible builds&#41;\n   \n   The macOS host is the surrounding forest:\n   - Wild, uncontrolled &#40;Homebrew, system packages&#41;\n   - But rich and diverse &#40;many tools&#41;\n   \n   The VM garden exists within the forest,\n   cultivated space within wild space,\n   order within chaos,\n   reproducibility within entropy.\n   \n   This is Wu Wei applied to infrastructure:\n   Effortless action through proper structure.&quot;\n \n :from-i-ching\n &quot;Hexagram 3: Difficulty at the Beginning &#40;屯 Zhun&#41;\n   \n   'Times of growth are beset with difficulties.\n    They resemble a first birth.\n    But these difficulties arise from the very profusion of all that is struggling to attain form.\n    Everything is in motion: therefore if one perseveres there is a prospect of great success.'\n   \n   Setting up the VM is difficulty at the beginning.\n   Partitioning, configuring, troubleshooting.\n   But once established, great success follows:\n   Reproducible development environment,\n   Fearless experimentation,\n   Team collaboration.\n   \n   Perseverance furthers.&quot;\n \n :from-gospel\n &quot;\\&quot;Therefore everyone who hears these words of mine and puts them into practice\n    is like a wise man who built his house on the rock.\n    The rain came down, the streams rose, and the winds blew and beat against that house;\n    yet it did not fall, because it had its foundation on the rock.\\&quot;\n    — Matthew 7:24-25\n   \n   The VirtualBox VM is the house on rock:\n   - Foundation: NixOS declarative config\n   - Rock: Immutable Nix store\n   - Rain: Dependency updates\n   - Streams: Team members pulling code\n   - Winds: macOS upgrades\n   \n   The house stands because it's built on rock,\n   not sand &#40;mutable system state&#41;.&quot;}\n</code></pre><h2>Conclusion: The Complete Environment</h2><pre><code class=\"clojure\">{:the-stack\n {:layer-1-hardware &quot;MacBook Pro &#40;macOS Sequoia&#41;&quot;\n  :layer-2-hypervisor &quot;VirtualBox 7.x&quot;\n  :layer-3-guest-os &quot;NixOS 24.05 &#40;declarative, reproducible&#41;&quot;\n  :layer-4-dev-env &quot;nix develop &#40;project flake.nix&#41;&quot;\n  :layer-5-tools &quot;babashka, clojure, node&quot;\n  :layer-6-application &quot;Robotic Farm pipeline&quot;\n  \n  :beauty\n  &quot;Each layer declaratively configured:\n   - VirtualBox: VBoxManage scripts\n   - NixOS: configuration.nix\n   - Dev env: flake.nix\n   - Application: bb.edn, deps.edn\n   \n   Reproducibility all the way down.\n   Infrastructure as code, deeply nested.\n   Gardens within gardens.&quot;}\n \n :next-steps\n &#91;&quot;Run ./scripts/setup-virtualbox-vm.sh&quot;\n  &quot;Install NixOS using automated or manual process&quot;\n  &quot;Configure SSH keys for passwordless access&quot;\n  &quot;Enter nix develop in VM&quot;\n  &quot;Build your project: bb build:pipeline&quot;\n  &quot;Create snapshot for safety&quot;\n  &quot;Document any customizations in nixos/vm-configuration.nix&quot;\n  &quot;Commit everything to Git&quot;\n  &quot;Share VM export with team &#40;optional&#41;&quot;&#93;\n \n :the-promise\n &quot;Now you have a reproducible development environment that:\n  - Works identically on any macOS machine\n  - Can be snapshotted before risky changes\n  - Keeps your host OS clean\n  - Uses declarative configuration &#40;version controlled&#41;\n  - Integrates with your existing Nix-based project\n  - Can be exported and shared with team\n  - Survives macOS upgrades and host system changes\n  \n  This is infrastructure as contemplative practice:\n  Mindful, deliberate, reproducible.\n  \n  L'dor v'dor—from generation to generation.&quot;}\n</code></pre><h2>References & Further Reading</h2><pre><code class=\"clojure\">{:virtualbox\n &#91;&quot;VirtualBox User Manual: https://www.virtualbox.org/manual/&quot;\n  &quot;VBoxManage Reference: https://www.virtualbox.org/manual/ch08.html&quot;\n  &quot;VirtualBox Downloads: https://www.virtualbox.org/wiki/Downloads&quot;&#93;\n \n :nixos\n &#91;&quot;NixOS Manual: https://nixos.org/manual/nixos/stable/&quot;\n  &quot;NixOS Wiki: https://nixos.wiki/&quot;\n  &quot;Nix Pills: https://nixos.org/guides/nix-pills/&quot;&#93;\n \n :flakes\n &#91;&quot;Nix Flakes: https://nixos.wiki/wiki/Flakes&quot;\n  &quot;Zero to Nix: https://zero-to-nix.com/&quot;\n  &quot;Flake Reference: https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html&quot;&#93;\n \n :philosophy\n &#91;&quot;The Way of Ch'an &#40;David Hinton&#41;&quot;\n  &quot;I Ching &#40;Richard Wilhelm translation&#41;&quot;\n  &quot;The Analects of Confucius &#40;Edward Slingerland&#41;&quot;\n  &quot;Gospel of Matthew &#40;on building foundations&#41;&quot;&#93;}\n</code></pre><h2></h2><p><strong>Next Writing:</strong> 9995 — <em>(To be determined—perhaps \"Kubernetes GitOps with Nix\" or \"ClojureScript Build Tools\")</em><br /> <strong>Previous Writing:</strong> <a href='9997-framework-laptop-microkernel-dev'>9997-framework-laptop-microkernel-dev.md</a> — Framework Laptop Microkernel Development<h2></h2></p><p>*\"As above, so below.<br /> As the macOS, so the VM.<br /> As the host, so the guest.<br /> Gardens within gardens,<br /> consciousness reflecting consciousness,<br /> reproducibility nested in reproducibility.\"*</p><p>— From the Hermetic tradition, applied to virtualization</p><p><em>The setup is complete. The environment is ready. The work begins anew.</em></p><h2></h2><h1>Part IV: Container Philosophy — Alpine vs NixOS</h1><h2>The Two Philosophies</h2><pre><code class=\"clojure\">{:alpine-linux\n {:philosophy &quot;Minimalism through subtraction &#40;減 jiǎn&#41;&quot;\n  :approach &quot;Start with nothing, add only what's necessary&quot;\n  :analogies &#91;&quot;Zen rock garden&quot;\n              &quot;Hemingway's prose&quot;\n              &quot;Bauhaus design&quot;&#93;\n  \n  :principles\n  {:simplicity &quot;Use busybox for core utilities&quot;\n   :security &quot;Small surface area → fewer vulnerabilities&quot;\n   :efficiency &quot;musl libc → smaller, simpler&quot;\n   :pragmatism &quot;Good enough for most use cases&quot;}\n  \n  :base-image &quot;&#126;5-7 MB&quot;\n  :libc &quot;musl &#40;POSIX-compliant, minimal&#41;&quot;\n  :package-manager &quot;apk &#40;Alpine Package Keeper&#41;&quot;\n  :update-model &quot;Rolling release &#40;edge&#41; or stable branches&quot;\n  \n  :from-tao-te-ching\n  &quot;In the pursuit of learning, every day something is acquired.\n   In the pursuit of Tao, every day something is dropped.\n   — Chapter 48\n   \n   Alpine drops everything non-essential.&quot;}\n \n :nixos\n {:philosophy &quot;Completeness through purity &#40;純 chún&#41;&quot;\n  :approach &quot;Declare everything precisely, guarantee reproducibility&quot;\n  :analogies &#91;&quot;Cathedral blueprint&quot;\n              &quot;Mathematical proof&quot;\n              &quot;Functional programming&quot;&#93;\n  \n  :principles\n  {:reproducibility &quot;Same inputs → identical outputs&quot;\n   :isolation &quot;Content-addressed store paths&quot;\n   :declarative &quot;System configuration as code&quot;\n   :purity &quot;Builds in isolated sandboxes&quot;}\n  \n  :base-image &quot;&#126;50-200 MB &#40;depends on closure&#41;&quot;\n  :libc &quot;glibc &#40;standard, full-featured&#41;&quot;\n  :package-manager &quot;nix &#40;functional, declarative&#41;&quot;\n  :update-model &quot;Atomic upgrades, rollbacks, generations&quot;\n  \n  :from-i-ching\n  &quot;The Creative works sublime success,\n   Furthering through perseverance.\n   — Hexagram 1 &#40;乾 Qian&#41;\n   \n   NixOS creates complete, self-contained systems.&quot;}\n \n :the-tension\n &quot;Alpine asks: 'What can we remove?'\n  NixOS asks: 'What must we guarantee?'\n  \n  Both are noble questions.\n  Both lead to excellence.\n  But they optimize for different virtues.&quot;}\n</code></pre><h2>Container Size & Reproducibility Tradeoffs</h2><pre><code class=\"clojure\">{:alpine-tradeoffs\n {:image-size &quot;&#126;207 MB for Clojure web service&quot;\n  :reproducibility-score &quot;6/10 with best practices&quot;\n  :challenge &quot;Package versions drift over time&quot;\n  \n  :mitigation\n  &#91;&quot;Pin Alpine base by digest&quot;\n   &quot;Pin every package version explicitly&quot;\n   &quot;Private Alpine mirror with frozen packages&quot;&#93;}\n \n :nixos-tradeoffs\n {:image-size &quot;&#126;330 MB for same service &#40;but shared layers at scale&#41;&quot;\n  :reproducibility-score &quot;10/10&quot;\n  :guarantee &quot;Bit-for-bit identical builds&quot;\n  \n  :cluster-efficiency\n  &quot;At 10+ services, NixOS wins via content-addressed layer sharing&quot;}}\n</code></pre><h2></h2><h1>Part IV: Build Management — Leiningen vs Nix</h1><h2>Core Similarities</h2><pre><code class=\"clojure\">{:shared-concerns\n {:dependency-management\n  {:leiningen &quot;Manages Java/Clojure dependencies via Maven coordinates&quot;\n   :nix &quot;Manages system packages via content-addressed store paths&quot;\n   :similarity &quot;Both track what your project needs&quot;}\n  \n  :declarative-configuration\n  {:leiningen &quot;project.clj declares dependencies, plugins, profiles&quot;\n   :nix &quot;&#42;.nix files declare packages, build steps, environments&quot;\n   :similarity &quot;Both use files to specify 'what', not 'how'&quot;}\n  \n  :reproducibility-goals\n  {:leiningen &quot;Same project.clj → same dependencies &#40;ideally&#41;&quot;\n   :nix &quot;Same flake.lock → same build &#40;guaranteed&#41;&quot;\n   :similarity &quot;Both aim to eliminate 'works on my machine'&quot;}}}\n</code></pre><h2>Fundamental Differences</h2><h3>Scope & Abstraction Level</h3><pre><code class=\"clojure\">{:leiningen\n {:scope :application-build\n  :domain :clojure-jvm\n  :abstraction-level :project\n  \n  :manages\n  &#91;&quot;Clojure dependencies &#40;from Maven/Clojars&#41;&quot;\n   &quot;Java dependencies &#40;via Maven coordinates&#41;&quot;\n   &quot;Build tasks &#40;compile, test, uberjar, deploy&#41;&quot;\n   &quot;REPL environment&quot;&#93;\n  \n  :assumes-exist\n  &#91;&quot;Java Development Kit &#40;JDK&#41;&quot;\n   &quot;Leiningen itself &#40;bootstrap&#41;&quot;\n   &quot;Network access to Maven Central/Clojars&quot;&#93;}\n \n :nix\n {:scope :system-wide-configuration\n  :domain :any-software\n  :abstraction-level :operating-system\n  \n  :manages\n  &#91;&quot;Programming language runtimes &#40;JDK, Python, Node.js&#41;&quot;\n   &quot;Build tools &#40;Leiningen, Cargo, npm&#41;&quot;\n   &quot;System libraries &#40;OpenSSL, zlib, glibc&#41;&quot;\n   &quot;Entire OS configurations &#40;NixOS&#41;&quot;&#93;\n  \n  :assumes-exist\n  &#91;&quot;Nix package manager itself&quot;\n   &quot;Linux kernel &#40;or macOS Darwin&#41;&quot;\n   &quot;Nix store directory &#40;/nix/store&#41;&quot;&#93;}}\n</code></pre><p><strong>The Key Insight:</strong></p><pre><code class=\"clojure\">{:metaphor\n &quot;Leiningen is a chef's recipe—assumes a kitchen exists.\n  Nix is an architect's blueprint for the entire restaurant.&quot;}\n</code></pre><h3>Dependency Resolution Philosophy</h3><pre><code class=\"clojure\">{:leiningen-resolution\n {:timing :runtime\n  :approach :dynamic\n  :idempotency &quot;Best effort&quot;\n  :problem &quot;Library republished → different bytes for 'same' version&quot;}\n \n :nix-resolution\n {:timing :build-time\n  :approach :static\n  :idempotency &quot;Cryptographically guaranteed&quot;\n  :guarantee &quot;Same flake.lock → bit-for-bit identical build&quot;}}\n</code></pre><h2>When to Use Which</h2><h3>Alpine + Leiningen</h3><p><strong>Use When:</strong></p><ul><li>Small team (< 5 people)</li><li>Pure Clojure projects</li><li>Fast iteration priority</li><li>Simple deployment (uberjars to servers)</li></ul><p><strong>Example Dockerfile:</strong></p><pre><code class=\"dockerfile\">FROM alpine:3.19 AS builder\nRUN apk add --no-cache openjdk17 bash curl\n# Install Leiningen, build uberjar\nFROM alpine:3.19\nRUN apk add --no-cache openjdk17-jre\nCOPY --from=builder /build/target/&#42;-standalone.jar ./app.jar\nCMD &#91;&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;&#93;\n</code></pre><h3>NixOS + Nix</h3><p><strong>Use When:</strong></p><ul><li>Regulated industries (SOC2, PCI, HIPAA)</li><li>Multi-language projects (Clojure + Python + Node.js + Rust)</li><li>Large scale (15+ services benefit from layer deduplication)</li><li>Long-term maintenance (decades)</li></ul><p><strong>Example flake.nix:</strong></p><pre><code class=\"nix\">{\n  outputs = { self, nixpkgs }: {\n    packages.x86&#95;64-linux.docker = pkgs.dockerTools.buildLayeredImage {\n      name = &quot;my-app&quot;;\n      contents = &#91; myapp pkgs.cacert &#93;;\n      config.Cmd = &#91; &quot;${myapp}/bin/myapp&quot; &#93;;\n    };\n  };\n}\n</code></pre><h3>The Hybrid Approach</h3><pre><code class=\"clojure\">{:best-of-both\n &quot;Use Nix for dev environment &#40;flake.nix provides JDK, tools&#41;.\n  Use Leiningen for builds &#40;fast REPL iteration&#41;.\n  Deploy uberjars &#40;simple, familiar to ops&#41;.\n  \n  This is the harmonious middle way!&quot;}\n</code></pre><h2></h2><h1>Part IV: Real-World Decision Matrix</h1><h2>Scenario-Based Recommendations</h2><pre><code class=\"clojure\">{:early-stage-startup\n {:alpine-leiningen &quot;⭐⭐⭐⭐⭐ Excellent&quot;\n  :reasoning\n  &#91;&quot;Team knows Docker already&quot;\n   &quot;Fast iteration critical&quot;\n   &quot;Small scale—size differences negligible&quot;&#93;\n  \n  :nixos-nix &quot;⭐⭐ Poor&quot;\n  :reasoning\n  &#91;&quot;Learning curve would slow team&quot;\n   &quot;Over-engineering for current scale&quot;&#93;}\n \n :fintech-regulated\n {:alpine-leiningen &quot;⭐⭐⭐ Acceptable&quot;\n  :reasoning\n  &#91;&quot;Can meet compliance with discipline&quot;\n   &quot;Pin all versions explicitly&quot;\n   &quot;Maintain private Alpine mirror&quot;&#93;\n  \n  :nixos-nix &quot;⭐⭐⭐⭐⭐ Excellent&quot;\n  :reasoning\n  &#91;&quot;Reproducibility required by auditors&quot;\n   &quot;Provenance built-in &#40;flake.lock&#41;&quot;\n   &quot;Bit-for-bit builds simplify audit trail&quot;&#93;}\n \n :polyglot-platform\n {:alpine-leiningen &quot;⭐⭐ Poor&quot;\n  :reasoning\n  &#91;&quot;Each language needs different patterns&quot;\n   &quot;Alpine's musl causes issues &#40;Python native extensions&#41;&quot;&#93;\n  \n  :nixos-nix &quot;⭐⭐⭐⭐⭐ Excellent&quot;\n  :reasoning\n  &#91;&quot;Single flake.nix manages all languages&quot;\n   &quot;Unified dependency management&quot;\n   &quot;glibc compatibility for all ecosystems&quot;&#93;}}\n</code></pre><h2>The Confucian Five Relationships</h2><pre><code class=\"clojure\">{:five-relationships-in-systems\n {1 {:entities &#91;&quot;Developer&quot; &quot;Build Tool&quot;&#93;\n     :alpine-leiningen &quot;Tool adapts to dev's needs&quot;\n     :nixos-nix &quot;Tool enforces purity&quot;\n     :virtue &quot;Respect &#40;敬&#41;&quot;}\n  \n  2 {:entities &#91;&quot;Code&quot; &quot;Dependencies&quot;&#93;\n     :alpine-leiningen &quot;Dependencies resolved at runtime&quot;\n     :nixos-nix &quot;Dependencies locked at declaration&quot;\n     :virtue &quot;Trust &#40;信&#41;&quot;}\n  \n  3 {:entities &#91;&quot;Build Process&quot; &quot;Environment&quot;&#93;\n     :alpine-leiningen &quot;Process trusts environment&quot;\n     :nixos-nix &quot;Process creates own environment&quot;\n     :virtue &quot;Self-reliance &#40;自立&#41;&quot;}\n  \n  4 {:entities &#91;&quot;Development&quot; &quot;Production&quot;&#93;\n     :alpine-leiningen &quot;Similar but not identical&quot;\n     :nixos-nix &quot;Bit-for-bit identical&quot;\n     :virtue &quot;Consistency &#40;一致&#41;&quot;}\n  \n  5 {:entities &#91;&quot;Present Build&quot; &quot;Future Build&quot;&#93;\n     :alpine-leiningen &quot;Depends on what's available then&quot;\n     :nixos-nix &quot;Guaranteed same if inputs unchanged&quot;\n     :virtue &quot;Continuity &#40;連續&#41;&quot;}}}\n</code></pre><h2>Conclusion: The Way of Harmony</h2><pre><code class=\"clojure\">{:synthesis\n &quot;Alpine and Leiningen represent pragmatic minimalism—\n  trust the ecosystem, iterate quickly, accept some uncertainty.\n  \n  NixOS and Nix represent principled completeness—\n  control everything, guarantee reproducibility, invest upfront.\n  \n  Neither is universally superior. Context determines the right choice.\n  \n  For most teams:\n  Start with Alpine + Leiningen &#40;familiar, fast&#41;.\n  Migrate to NixOS + Nix when you hit:\n  - Reproducibility pain &#40;drift, dependency hell&#41;\n  - Scale challenges &#40;many services, layer duplication&#41;\n  - Compliance requirements &#40;audit trails, provenance&#41;\n  - Polyglot complexity &#40;managing many ecosystems&#41;\n  \n  The complete stack:\n  \n  ┌─────────────────────────────────────────┐\n  │ Nix &#40;System Layer&#41;                      │\n  │ - Provides JDK, Leiningen, tools       │\n  │ - Guarantees reproducible environment   │\n  └───────────┬─────────────────────────────┘\n              │\n              ↓\n  ┌─────────────────────────────────────────┐\n  │ Leiningen/Alpine &#40;Application Layer&#41;    │\n  │ - Manages Clojure dependencies         │\n  │ - Fast iteration, familiar patterns     │\n  └───────────┬─────────────────────────────┘\n              │\n              ↓\n  ┌─────────────────────────────────────────┐\n  │ Your Clojure Code                       │\n  │ - Business logic                        │\n  │ - Runs in reproducible environment      │\n  │ - Developed with fast REPL feedback     │\n  └─────────────────────────────────────────┘\n  \n  This is the way of Wu Wei &#40;無為&#41;—effortless action.\n  Each tool does what it does best, without forcing.&quot;}\n \n :from-the-gospel\n &quot;Render unto Caesar the things that are Caesar's,\n  and unto God the things that are God's. — Mark 12:17\n  \n  Application:\n  Render unto Nix the system configuration,\n  Render unto Leiningen the Clojure builds,\n  Render unto Alpine the minimal runtime,\n  Render unto NixOS the complete reproducibility.&quot;}\n</code></pre><h2>References & Further Reading</h2><pre><code class=\"clojure\">{:alpine-linux\n &#91;&quot;https://alpinelinux.org/&quot;\n  &quot;https://wiki.alpinelinux.org/wiki/Docker&quot;\n  &quot;musl vs glibc: https://wiki.musl-libc.org/functional-differences-from-glibc.html&quot;&#93;\n \n :nixos\n &#91;&quot;https://nixos.org/&quot;\n  &quot;Nix Docker Tools: https://nixos.org/manual/nixpkgs/stable/#sec-pkgs-dockerTools&quot;\n  &quot;Zero to Nix: https://zero-to-nix.com/&quot;&#93;\n \n :leiningen\n &#91;&quot;https://leiningen.org/&quot;\n  &quot;Leiningen Tutorial: https://github.com/technomancy/leiningen/blob/stable/doc/TUTORIAL.md&quot;&#93;\n \n :philosophy\n &#91;&quot;Tao Te Ching &#40;on minimalism vs completeness&#41;&quot;\n  &quot;I Ching &#40;on complementary forces&#41;&quot;\n  &quot;Confucius, Analects &#40;on the Mean&#41;&quot;\n  &quot;Gospel of Matthew &amp; Mark &#40;on rendering unto each their due&#41;&quot;&#93;}\n</code></pre><h2></h2><p><strong>Next Writing:</strong> 9995 — <em>(To be determined)</em><br /> <strong>Previous Writing:</strong> <a href='9997-framework-laptop-microkernel-dev'>9997-framework-laptop-microkernel-dev.md</a> — Framework Laptop Microkernel Development<h2></h2></p><p>*\"In dwelling, live close to the ground.<br /> In thinking, keep to the simple.<br /> In conflict, be fair and generous.<br /> In governing, don't try to control.<br /> In work, do what you enjoy.<br /> In family life, be completely present.\"*</p><p>— Laozi, Tao Te Ching, Chapter 8</p><p>*Alpine dwells close to the ground (minimal).<br /> NixOS thinks simply (declarative).<br /> Leiningen works with what you enjoy (REPL flow).<br /> Nix doesn't try to control (each tool has its place).<br /> Be completely present in your choice (commit fully).*<h2></h2></p><p><div style=\"text-align: center; opacity: 0.6; font-size: 0.85em; margin-top: 3em; padding-top: 1em; border-top: 1px solid rgba(139, 116, 94, 0.2);\"></p><p><strong>Copyright © 2025 <a href='https://codeberg.org/kae3g/12025-10/'>kae3g</a></strong> | Dual-licensed under <a href='https://www.apache.org/licenses/LICENSE-2.0'>Apache-2.0</a> / <a href='https://opensource.org/licenses/MIT'>MIT</a><br /> Competitive technology in service of clarity and beauty</p><p></div></p><p><em><a href='/12025-10/hidden-docs-index.html'>View Hidden Docs Index</a></em> | <em><a href='/12025-10/'>Return to Main Index</a></em></p>",
  "hash" : "2025-10-23T00:27:48.77573044Z-47196"
}